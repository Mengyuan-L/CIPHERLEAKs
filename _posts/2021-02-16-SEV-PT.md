---
layout: post
title:  "SEV Page Table"
author: mengyuan
categories: [ Jekyll, tutorial ]
image: assets/images/npt.png
---
# Nested Page Table

AMD adopts two-level nested page tables (NPT) to help the hypervisor manage the SEV VM's memory mapping. The upper-level page table, also called the guest page table (gPT), is part of the guest VM's encrypted memory and is maintained by the guest VM, and is usually a 4-level page table that translates the guest virtual address (gVA) to the guest physical address (gPA). Moreover, Guest Page Fault (gPF) caused by the gPT walk is trapped and handled by the guest VM. The lower-level page table is also called NPT or host page table (hPT), which translates gPA to system physical address (sPA), and is maintained by the hypervisor. The entire address translation is shown in the figure below. 

![npt_1]({{ site.baseurl }}/assets/images/npt_1.png)

The NPT structure gives the SEV VM the ability to configure the memory pages' encryption states. By changing the C-bit (Bit 47 in the page table entry) to be 1 or 0, the states of the guest VM's memory page can either be private (encrypted with his  $K_{vek}$) or shared (encrypted with the hypervisor's $K_{vek}$). The gPT and all instruction pages are forced to be private states no matter the value of C-bit.

Moreover, the Nested Page Fault (NPF) may be triggered by the hardware during the NPT walk. According to the NPF event, the hypervisor can grab helpful information that could reflect the behavior of a program, and therefore leak sensitive information, including the gPA of the NPT and the NPF error code [1]. This forms a well-known controlled-channel attack [2-4], which compromises SEV's confidentiality and integrity.

## Reference

[1] AMD. "AMD64 architecture programmer’s manual volume 2: System programming." (2020).

[2] Li, Mengyuan, Yinqian Zhang, Zhiqiang Lin, and Yan Solihin. "Exploiting unprotected i/o operations in amd’s secure encrypted virtualization." In 28th USENIX Security Symposium (USENIX Security 19), pp. 1257-1272. 2019.

[3] Werner, Jan, Joshua Mason, Manos Antonakakis, Michalis Polychronakis, and Fabian Monrose. "The severest of them all: Inference attacks against secure virtual enclaves." In Proceedings of the 2019 ACM Asia Conference on Computer and Communications Security, pp. 73-85. 2019.

[4] Hetzelt, Felicitas, and Robert Buhren. "Security analysis of encrypted virtual machines." ACM SIGPLAN Notices 52, no. 7 (2017): 129-142.